# ═══════════════════════════════════════════════════
#  Scalara – Docker Compose
#  Quick deployment for development or production
# ═══════════════════════════════════════════════════

version: "3.9"

services:
  # ─── PostgreSQL Database ───────────────────────
  db:
    image: postgres:16-alpine
    container_name: scalara-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: scalara
      POSTGRES_PASSWORD: ${DB_PASSWORD:-scalara_secure_password}
      POSTGRES_DB: scalara
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scalara"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - scalara-net

  # ─── Scalara Webmail ───────────────────────────
  webmail:
    build:
      context: ./webmail
      dockerfile: Dockerfile
    container_name: scalara-webmail
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: "postgresql://scalara:${DB_PASSWORD:-scalara_secure_password}@db:5432/scalara?schema=public"
      NEXTAUTH_URL: "https://${WEBMAIL_HOSTNAME:-localhost:3000}"
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-this-in-production}
      IMAP_HOST: ${IMAP_HOST:-mail.example.com}
      IMAP_PORT: ${IMAP_PORT:-993}
      SMTP_HOST: ${SMTP_HOST:-mail.example.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-generate-a-64-char-hex-key}
      NODE_ENV: production
    ports:
      - "3000:3000"
    networks:
      - scalara-net

  # ─── Nginx Reverse Proxy ──────────────────────
  nginx:
    image: nginx:alpine
    container_name: scalara-nginx
    restart: unless-stopped
    depends_on:
      - webmail
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./installer/templates/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ssl-certs:/etc/letsencrypt:ro
      - certbot-data:/var/www/certbot:ro
    networks:
      - scalara-net

  # ─── Certbot (SSL) ───────────────────────────
  certbot:
    image: certbot/certbot
    container_name: scalara-certbot
    volumes:
      - ssl-certs:/etc/letsencrypt
      - certbot-data:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - scalara-net

volumes:
  pgdata:
    driver: local
  ssl-certs:
    driver: local
  certbot-data:
    driver: local

networks:
  scalara-net:
    driver: bridge
